<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de Finanzas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .sidebar-link {
            transition: background-color 0.2s, color 0.2s;
        }
        /* Estilos para la barra de desplazamiento */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="relative min-h-screen md:flex">
        <!-- Barra de Navegación Lateral (Sidebar) -->
        <nav id="sidebar" class="bg-gray-800 text-white w-64 p-4 flex-shrink-0 flex-col space-y-4 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30">
            <div class="text-center pb-4 border-b border-gray-700">
                <h1 class="text-2xl font-bold">Finanzas</h1>
            </div>
            <ul class="flex-grow">
                <li><a href="#view-panel" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-700 bg-gray-700"><i class="fas fa-chart-pie w-6"></i><span class="ml-3">Panel Principal</span></a></li>
                <li><a href="#view-add-expense" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-700"><i class="fas fa-plus-circle w-6"></i><span class="ml-3">Agregar Gasto</span></a></li>
                <li><a href="#view-people" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-700"><i class="fas fa-users w-6"></i><span class="ml-3">Personas</span></a></li>
            </ul>
            <div class="text-xs text-gray-400 text-center break-words">
                <p>Datos guardados localmente</p>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <div class="flex-1 flex flex-col">
             <!-- Cabecera Móvil con botón de menú -->
            <header class="md:hidden flex items-center gap-4 bg-gray-800 text-white p-4 sticky top-0 z-10 shadow-md">
                <button id="menu-button" class="text-white focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <h1 class="text-xl font-bold">Finanzas</h1>
            </header>

            <main id="main-content" class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto">
            
                <!-- Vista: Panel Principal -->
                <div id="view-panel" class="view">
                    <header class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900">Registro de Gastos</h2>
                        <p class="text-gray-600 mt-1">Visualiza y filtra tus deudas y gastos.</p>
                    </header>
                     <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                         <!-- Filtros -->
                        <div class="flex flex-col md:flex-row gap-4 mb-4 pb-4 border-b items-end">
                            <div class="flex-1 w-full">
                                <label for="filterPerson" class="block text-sm font-medium text-gray-700">Filtrar por persona</label>
                                <select id="filterPerson" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="all">Todas las personas</option>
                                </select>
                            </div>
                            <div class="flex-1 w-full">
                                <label for="filterStartDate" class="block text-sm font-medium text-gray-700">Mostrar gastos desde</label>
                                <input type="date" id="filterStartDate" name="filterStartDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div class="flex items-center pb-2">
                                <div class="relative flex items-start">
                                    <div class="flex h-6 items-center">
                                        <input id="filterMonth" name="filterMonth" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600">
                                    </div>
                                    <div class="ml-3 text-sm leading-6">
                                        <label for="filterMonth" class="font-medium text-gray-900">Solo mes actual</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                         <!-- Lista de Gastos: Ahora con altura máxima y scroll -->
                        <div id="expensesList" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                            <!-- Los gastos se mostrarán aquí -->
                        </div>

                         <!-- Total y Acciones -->
                        <div class="mt-6 pt-4 border-t-2 border-dashed">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold">Total:</h3>
                                <p id="totalAmount" class="text-2xl font-bold text-indigo-600">$0.00</p>
                            </div>
                            <div class="mt-4 flex flex-col sm:flex-row justify-end gap-3">
                                <button id="printButton" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 text-sm">
                                    Imprimir Registro
                                </button>
                                <button id="deleteVisibleButton" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 text-sm">
                                    Eliminar Gastos Mostrados
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista: Agregar Gasto -->
                <div id="view-add-expense" class="view hidden">
                     <header class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900">Agregar Gasto/Deuda</h2>
                        <p class="text-gray-600 mt-1">Registra una nueva transacción.</p>
                    </header>
                    <div class="bg-white p-6 rounded-xl shadow-md max-w-lg mx-auto">
                        <form id="addExpenseForm" class="space-y-4">
                            <div>
                                <label for="expensePerson" class="block text-sm font-medium text-gray-700">Persona</label>
                                <select id="expensePerson" name="expensePerson" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="">Selecciona una persona</option>
                                </select>
                            </div>
                            <div>
                                <label for="expenseDescription" class="block text-sm font-medium text-gray-700">Descripción</label>
                                <input type="text" id="expenseDescription" name="expenseDescription" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ej. Renta, Netflix, etc.">
                            </div>
                            <div>
                                <label for="expenseAmount" class="block text-sm font-medium text-gray-700">Monto</label>
                                <div class="relative mt-1 rounded-md shadow-sm">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <span class="text-gray-500 sm:text-sm">$</span>
                                    </div>
                                    <input type="number" id="expenseAmount" name="expenseAmount" required min="0.01" step="0.01" class="block w-full rounded-md border-gray-300 pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="0.00">
                                </div>
                            </div>
                            
                            <!-- Opciones de Gasto Recurrente -->
                            <div class="relative flex items-start">
                                <div class="flex h-5 items-center">
                                    <input id="isRecurring" name="isRecurring" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="isRecurring" class="font-medium text-gray-700">Gasto Recurrente</label>
                                    <p class="text-gray-500">Marque si este gasto se repetirá mensualmente.</p>
                                </div>
                            </div>

                            <div id="recurringOptions" class="hidden space-y-4 pl-8 border-l-2 border-indigo-200 ml-2 py-2">
                                <p class="text-sm font-medium text-gray-700">¿Cuándo se debe cobrar?</p>
                                <div class="relative flex items-start">
                                    <div class="flex h-5 items-center">
                                        <input id="recurringTypeToday" name="recurringType" type="radio" value="today" checked class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="recurringTypeToday" class="font-medium text-gray-900">El mismo día de hoy</label>
                                        <p class="text-gray-500">Se cobrará el día <span id="todayDateSpan"></span> de cada mes.</p>
                                    </div>
                                </div>
                                <div class="relative flex items-start">
                                    <div class="flex h-5 items-center">
                                        <input id="recurringTypeSpecific" name="recurringType" type="radio" value="specific" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="recurringTypeSpecific" class="font-medium text-gray-900">Un día específico del mes</label>
                                    </div>
                                </div>
                                <div id="specificDayWrapper" class="hidden pl-8">
                                    <label for="specificDayInput" class="block text-sm font-medium text-gray-700">Día del mes (1-31)</label>
                                    <input type="number" id="specificDayInput" name="specificDayInput" min="1" max="31" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej. 15">
                                    <p class="mt-1 text-xs text-gray-500">Si el mes no tiene el día seleccionado (ej. día 31 en febrero), se usará el último día del mes.</p>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                                Agregar Gasto
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Vista: Personas (Ahora expande y la lista es desplazable) -->
                <div id="view-people" class="view hidden flex flex-col">
                     <header class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900">Gestionar Personas</h2>
                         <p class="text-gray-600 mt-1">Agrega o elimina personas de tu lista.</p>
                    </header>
                    <div class="bg-white p-6 rounded-xl shadow-md max-w-lg mx-auto w-full flex-1 flex flex-col">
                        <form id="addPersonForm" class="space-y-4">
                            <div>
                                <label for="personName" class="block text-sm font-medium text-gray-700">Nombre de la Persona</label>
                                <input type="text" id="personName" name="personName" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ej. Juliana">
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                                Agregar Persona
                            </button>
                        </form>
                        <div id="peopleList" class="mt-6 space-y-3 flex-1 overflow-y-auto pr-2">
                            <!-- Las personas agregadas se mostrarán aquí -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Overlay para menú móvil -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <!-- Modal de Confirmación Genérico -->
    <div id="confirmationModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95">
            <h3 class="text-lg font-medium leading-6 text-gray-900" id="modalTitle"></h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500" id="modalMessage"></p>
            </div>
            <div class="mt-4 flex justify-end space-x-3">
                <button id="cancelButton" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="confirmButton" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Gastos Recurrentes -->
    <div id="recurringExpensesModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="recurringModalTitle">Gastos Recurrentes</h3>
            <div id="recurringList" class="space-y-2 max-h-60 overflow-y-auto">
                <!-- Lista de gastos recurrentes -->
            </div>
            <div class="mt-4 text-right">
                <button id="closeRecurringModalButton" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Compartir/Imprimir -->
    <div id="shareModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Resumen para Compartir</h3>
            <textarea id="shareText" readonly class="w-full h-40 p-2 border border-gray-300 rounded-md bg-gray-50 text-sm"></textarea>
            <div id="copyFeedback" class="text-sm text-green-600 h-4 mt-1"></div>
            <div class="mt-4 flex justify-end gap-3">
                <button id="copyButton" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Copiar</button>
                <button id="closeShareModalButton" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuración de IndexedDB ---
        const DB_NAME = 'FinanzasDB';
        const DB_VERSION = 1;
        const STORES = {
            PEOPLE: 'people',
            EXPENSES: 'expenses',
            RECURRING_EXPENSES: 'recurring_expenses'
        };

        let db = null;
        let people = [];
        let expenses = [];
        let recurringExpenses = [];
        let isCheckingRecurring = false;
        let confirmAction = null;
        
        // --- Referencias a elementos del DOM ---
        const sidebar = document.getElementById('sidebar');
        const menuButton = document.getElementById('menu-button');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const addPersonForm = document.getElementById('addPersonForm');
        const addExpenseForm = document.getElementById('addExpenseForm');
        const peopleListDiv = document.getElementById('peopleList');
        const expensePersonSelect = document.getElementById('expensePerson');
        const filterPersonSelect = document.getElementById('filterPerson');
        const expensesListDiv = document.getElementById('expensesList');
        const totalAmountEl = document.getElementById('totalAmount');
        const filterMonthCheckbox = document.getElementById('filterMonth');
        const filterStartDateInput = document.getElementById('filterStartDate');
        const deleteVisibleButton = document.getElementById('deleteVisibleButton');
        const printButton = document.getElementById('printButton');
        const views = document.querySelectorAll('.view');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        
        // Recurring expenses elements
        const isRecurringCheckbox = document.getElementById('isRecurring');
        const recurringOptionsDiv = document.getElementById('recurringOptions');
        const specificDayWrapper = document.getElementById('specificDayWrapper');
        const todayDateSpan = document.getElementById('todayDateSpan');

        // Modals
        const confirmationModal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const cancelButton = document.getElementById('cancelButton');
        const confirmButton = document.getElementById('confirmButton');
        const recurringExpensesModal = document.getElementById('recurringExpensesModal');
        const recurringModalTitle = document.getElementById('recurringModalTitle');
        const recurringListDiv = document.getElementById('recurringList');
        const closeRecurringModalButton = document.getElementById('closeRecurringModalButton');
        const shareModal = document.getElementById('shareModal');
        const shareText = document.getElementById('shareText');
        const copyButton = document.getElementById('copyButton');
        const copyFeedback = document.getElementById('copyFeedback');
        const closeShareModalButton = document.getElementById('closeShareModalButton');

        // --- FUNCIONES DE BASE DE DATOS ---

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORES.PEOPLE)) {
                        db.createObjectStore(STORES.PEOPLE, { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.EXPENSES)) {
                        const expensesStore = db.createObjectStore(STORES.EXPENSES, { keyPath: 'id', autoIncrement: true });
                        expensesStore.createIndex('personId', 'personId', { unique: false });
                        expensesStore.createIndex('date', 'date', { unique: false });
                        expensesStore.createIndex('recurringRuleId', 'recurringRuleId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.RECURRING_EXPENSES)) {
                        const recurringStore = db.createObjectStore(STORES.RECURRING_EXPENSES, { keyPath: 'id', autoIncrement: true });
                        recurringStore.createIndex('personId', 'personId', { unique: false });
                    }
                };
            });
        }

        async function addToStore(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAllFromStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteFromStore(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        // --- FUNCIONES DE LA APLICACIÓN ---

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        }

        function showConfirmationModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmAction = onConfirm;
            confirmationModal.classList.remove('hidden');
            confirmationModal.querySelector('.modal-content').classList.add('scale-100');
        }
        
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
                modal.querySelector('.modal-content').classList.remove('scale-100');
            });
            confirmAction = null;
        }

        function showRecurringModal(personId, personName) {
            recurringModalTitle.textContent = `Gastos Recurrentes de ${personName}`;
            const personRecurringExpenses = recurringExpenses.filter(r => r.personId === personId);
            recurringListDiv.innerHTML = '';
            if (personRecurringExpenses.length === 0) {
                recurringListDiv.innerHTML = `<p class="text-sm text-gray-500 text-center">No hay gastos recurrentes.</p>`;
            } else {
                personRecurringExpenses.forEach(rule => {
                    const ruleEl = document.createElement('div');
                    ruleEl.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                    ruleEl.innerHTML = `
                        <div>
                            <p class="font-medium">${rule.description}</p>
                            <p class="text-sm text-gray-600">${formatCurrency(rule.amount)} / Día ${rule.dayOfMonth} de cada mes</p>
                        </div>
                        <button data-id="${rule.id}" class="delete-recurring-btn text-red-500 hover:text-red-700 font-bold p-2">&times;</button>
                    `;
                    recurringListDiv.appendChild(ruleEl);
                });
            }
            recurringExpensesModal.classList.remove('hidden');
            recurringExpensesModal.querySelector('.modal-content').classList.add('scale-100');
        }

        async function loadData() {
            try {
                db = await initDB();
                people = await getAllFromStore(STORES.PEOPLE);
                expenses = await getAllFromStore(STORES.EXPENSES);
                recurringExpenses = await getAllFromStore(STORES.RECURRING_EXPENSES);
                
                renderPeople();
                updateSelectOptions();
                await checkAndCreateRecurringExpenses();
                renderExpenses();

            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }
        
        function renderPeople() {
            peopleListDiv.innerHTML = '';
            if (people.length === 0) {
                 peopleListDiv.innerHTML = `<p class="text-sm text-center text-gray-500 mt-4">No hay personas agregadas.</p>`;
                 return;
            }
            people.forEach(person => {
                const personEl = document.createElement('div');
                personEl.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-100 p-3 rounded-md gap-2';
                personEl.innerHTML = `
                    <span class="text-gray-800 font-medium">${person.name}</span>
                    <div class="flex items-center gap-2 self-end sm:self-center">
                        <button data-person-id="${person.id}" data-person-name="${person.name}" class="manage-recurring-btn text-sm text-indigo-600 hover:text-indigo-800 font-semibold p-1 rounded hover:bg-indigo-100">Recurrentes</button>
                        <button data-id="${person.id}" class="delete-person-btn text-red-500 hover:text-red-700 text-xl font-bold p-1 rounded hover:bg-red-100">&times;</button>
                    </div>
                `;
                peopleListDiv.appendChild(personEl);
            });
        }

        function updateSelectOptions() {
            const options = people.map(p => `<option value="${p.id}" data-name="${p.name}">${p.name}</option>`).join('');
            expensePersonSelect.innerHTML = '<option value="">Selecciona una persona</option>' + options;
            filterPersonSelect.innerHTML = '<option value="all">Todas las personas</option>' + options;
        }

        function getFilteredExpenses() {
            const filterPersonId = filterPersonSelect.value;
            const filterByMonth = filterMonthCheckbox.checked;
            const filterStartDateValue = filterStartDateInput.value;

            return expenses.filter(expense => {
                const personMatch = filterPersonId === 'all' || expense.personId === parseInt(filterPersonId);
                if (!personMatch) return false;
                
                const expenseDate = new Date(expense.date + 'T00:00:00');

                if (filterByMonth) {
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                }

                if (filterStartDateValue) {
                    const filterStartDate = new Date(filterStartDateValue + 'T00:00:00');
                    return expenseDate >= filterStartDate;
                }
                
                return true;
            });
        }

        function renderExpenses() {
            expensesListDiv.innerHTML = '';
            const filteredExpenses = getFilteredExpenses();
            
            filteredExpenses.sort((a,b) => new Date(b.date) - new Date(a.date));

            if (filteredExpenses.length === 0) {
                expensesListDiv.innerHTML = `<p class="text-center text-gray-500 py-8">No hay gastos que coincidan con los filtros.</p>`;
                totalAmountEl.textContent = '$0.00';
                return;
            }

            let total = 0;
            filteredExpenses.forEach(expense => {
                const expenseEl = document.createElement('div');
                expenseEl.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-50 p-3 rounded-lg border gap-2';
                const formattedDate = formatSingleDate(expense.date);
                expenseEl.innerHTML = `
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">${expense.description}</p>
                        <p class="text-sm text-gray-500">${expense.personName} &bull; ${formattedDate}</p>
                    </div>
                    <div class="w-full sm:w-auto flex justify-between items-center mt-2 sm:mt-0">
                         <p class="font-bold text-lg text-gray-900 sm:text-right">${formatCurrency(expense.amount)}</p>
                         <button data-id="${expense.id}" class="delete-expense-btn text-xs text-red-500 hover:text-red-700 sm:ml-4 p-1">Eliminar</button>
                    </div>
                `;
                expensesListDiv.appendChild(expenseEl);
                total += parseFloat(expense.amount);
            });

            totalAmountEl.textContent = formatCurrency(total);
        }
        
        function formatSingleDate(dateStr) {
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('es-ES', options);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        }
        
        function handleGenerateShareableText() {
            const filteredExpenses = getFilteredExpenses();
            if (filteredExpenses.length === 0) {
                showConfirmationModal("Sin Gastos", "No hay gastos para compartir.", () => closeAllModals());
                return;
            }
            let message = "*Resumen de Gastos*\n\n";
            let total = 0;
            const selectedPersonId = filterPersonSelect.value;
            if (selectedPersonId !== 'all') {
                const personName = filterPersonSelect.options[filterPersonSelect.selectedIndex].text;
                message = `*Resumen de Gastos para ${personName}*\n\n`;
            }
            filteredExpenses.forEach(exp => {
                message += `• ${exp.description}: ${formatCurrency(exp.amount)}\n`;
                total += parseFloat(exp.amount);
            });
            message += `-------------------\n*Total:* ${formatCurrency(total)}`;
            shareText.value = message;
            copyFeedback.textContent = '';
            shareModal.classList.remove('hidden');
            shareModal.querySelector('.modal-content').classList.add('scale-100');
        }
        
        function handleCopyToClipboard() {
            shareText.select();
            shareText.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                copyFeedback.textContent = '¡Copiado!';
                 setTimeout(() => copyFeedback.textContent = '', 2000);
            } catch (err) {
                copyFeedback.textContent = 'Error al copiar';
                console.error('Fallback: Oops, unable to copy', err);
            }
        }

        async function handleAddPerson(e) {
            e.preventDefault();
            const personName = addPersonForm.personName.value.trim();
            if (personName) {
                try {
                    const newPerson = { name: personName };
                    const personId = await addToStore(STORES.PEOPLE, newPerson);
                    newPerson.id = personId;
                    people.push(newPerson);
                    renderPeople();
                    updateSelectOptions();
                    addPersonForm.reset();
                } catch (error) {
                    console.error('Error agregando persona:', error);
                }
            }
        }
        
        async function checkAndCreateRecurringExpenses() {
            if (isCheckingRecurring || recurringExpenses.length === 0) return;
            isCheckingRecurring = true;

            const today = new Date();
            const newExpensesCreated = [];

            for (const rule of recurringExpenses) {
                const generatedExpensesForRule = expenses.filter(e => e.recurringRuleId === rule.id);
                let lastGenDate;

                if (generatedExpensesForRule.length > 0) {
                    generatedExpensesForRule.sort((a, b) => new Date(b.date) - new Date(a.date));
                    lastGenDate = new Date(generatedExpensesForRule[0].date + 'T00:00:00');
                } else {
                    // BUG FIX: If no expenses exist for this rule, it's brand new.
                    // To prevent generating past expenses, treat the "last generated date" as today.
                    lastGenDate = new Date();
                }

                let cursorDate = new Date(lastGenDate.getUTCFullYear(), lastGenDate.getUTCMonth() + 1, 1);

                while (cursorDate <= today) {
                    const year = cursorDate.getFullYear();
                    const month = cursorDate.getMonth();
                    
                    const expenseAlreadyExists = expenses.some(exp =>
                        exp.recurringRuleId === rule.id &&
                        new Date(exp.date).getUTCFullYear() === year &&
                        new Date(exp.date).getUTCMonth() === month
                    );

                    if (!expenseAlreadyExists) {
                        const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
                        const chargeDay = Math.min(rule.dayOfMonth, lastDayOfMonth);
                        const newExpenseDate = new Date(Date.UTC(year, month, chargeDay));
                        const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                        if (newExpenseDate <= todayWithoutTime) {
                            const expenseData = {
                                personId: rule.personId,
                                personName: rule.personName,
                                description: rule.description,
                                amount: rule.amount,
                                date: newExpenseDate.toISOString().split('T')[0],
                                recurringRuleId: rule.id
                            };
                            newExpensesCreated.push(expenseData);
                        }
                    }
                    cursorDate = new Date(cursorDate.getFullYear(), cursorDate.getMonth() + 1, 1);
                }
            }

            for (const expenseData of newExpensesCreated) {
                try {
                    const expenseId = await addToStore(STORES.EXPENSES, expenseData);
                    expenseData.id = expenseId;
                    expenses.push(expenseData);
                } catch (error) {
                    console.error("Error creating recurring expense:", error);
                }
            }
            
            isCheckingRecurring = false;
        }

        async function handleAddExpense(e) {
            e.preventDefault();
            const personId = parseInt(addExpenseForm.expensePerson.value);
            const personName = addExpenseForm.expensePerson.options[addExpenseForm.expensePerson.selectedIndex].dataset.name;
            const description = addExpenseForm.expenseDescription.value.trim();
            const amount = parseFloat(addExpenseForm.expenseAmount.value);
            const isRecurring = isRecurringCheckbox.checked;
            const today = new Date();

            if (!personId || !description || !amount) return;

            try {
                if (isRecurring) {
                    const recurringType = document.querySelector('input[name="recurringType"]:checked').value;
                    let dayOfMonth;

                    if (recurringType === 'specific') {
                        const specificDay = parseInt(document.getElementById('specificDayInput').value);
                        if (!specificDay || specificDay < 1 || specificDay > 31) {
                            alert("Por favor, introduce un día del mes válido (1-31).");
                            return;
                        }
                        dayOfMonth = specificDay;
                    } else {
                        dayOfMonth = today.getDate();
                    }
                    
                    // 1. Create and save the recurring RULE
                    const recurringData = { personId, personName, description, amount, dayOfMonth };
                    const recurringId = await addToStore(STORES.RECURRING_EXPENSES, recurringData);
                    recurringData.id = recurringId;
                    recurringExpenses.push(recurringData);

                    // 2. Manually create and save the FIRST expense instance for today.
                    const firstExpenseData = {
                        personId,
                        personName,
                        description,
                        amount,
                        date: today.toISOString().split('T')[0], // Use today's date
                        recurringRuleId: recurringId // Link it to the new rule
                    };
                    const firstExpenseId = await addToStore(STORES.EXPENSES, firstExpenseData);
                    firstExpenseData.id = firstExpenseId;
                    expenses.push(firstExpenseData);

                } else {
                    const expenseData = { personId, personName, description, amount, date: today.toISOString().split('T')[0] };
                    const expenseId = await addToStore(STORES.EXPENSES, expenseData);
                    expenseData.id = expenseId;
                    expenses.push(expenseData);
                }
                
                addExpenseForm.reset();
                recurringOptionsDiv.classList.add('hidden');
                specificDayWrapper.classList.add('hidden');
                isRecurringCheckbox.checked = false;
                renderExpenses();
                document.querySelector('.sidebar-link[href="#view-panel"]').click();
            } catch (error) {
                console.error('Error agregando gasto:', error);
            }
        }

        async function handleDeleteRecurringExpense(ruleId) {
            try {
                await deleteFromStore(STORES.RECURRING_EXPENSES, ruleId);
                const deletedRule = recurringExpenses.find(r => r.id === ruleId);
                recurringExpenses = recurringExpenses.filter(r => r.id !== ruleId);
                showRecurringModal(deletedRule.personId, deletedRule.personName);
            } catch (error) {
                console.error("Error deleting recurring rule:", error);
            }
        }

        async function handleDeletePerson(personId) {
             showConfirmationModal(
                'Eliminar Persona',
                'Esto eliminará a la persona y todos sus gastos (incluyendo recurrentes). ¿Estás seguro?',
                async () => {
                    try {
                        const expensesToDelete = expenses.filter(e => e.personId === personId);
                        for (const expense of expensesToDelete) await deleteFromStore(STORES.EXPENSES, expense.id);
                        expenses = expenses.filter(e => e.personId !== personId);
                        
                        const recurringToDelete = recurringExpenses.filter(r => r.personId === personId);
                        for (const recurring of recurringToDelete) await deleteFromStore(STORES.RECURRING_EXPENSES, recurring.id);
                        recurringExpenses = recurringExpenses.filter(r => r.personId !== personId);
                        
                        await deleteFromStore(STORES.PEOPLE, personId);
                        people = people.filter(p => p.id !== personId);
                        
                        renderPeople();
                        updateSelectOptions();
                        renderExpenses();
                    } catch (error) {
                        console.error("Error al eliminar persona y sus datos: ", error);
                    } finally {
                        closeAllModals();
                    }
                }
            );
        }

        async function handleDeleteExpense(expenseId) {
            try {
                await deleteFromStore(STORES.EXPENSES, expenseId);
                expenses = expenses.filter(e => e.id !== expenseId);
                renderExpenses();
            } catch (error) {
                console.error('Error eliminando gasto:', error);
            }
        }
        
        async function handleDeleteVisibleExpenses() {
            const visibleExpenses = getFilteredExpenses();
            if (visibleExpenses.length === 0) {
                showConfirmationModal('Sin Gastos', 'No hay gastos mostrados para eliminar.', () => closeAllModals());
                return;
            }
            const message = `Se eliminarán los ${visibleExpenses.length} gastos mostrados. ¿Estás seguro?`;
            showConfirmationModal('Eliminar Gastos Visibles', message,
                async () => {
                    try {
                        const idsToDelete = visibleExpenses.map(exp => exp.id);
                        for (const id of idsToDelete) {
                            await deleteFromStore(STORES.EXPENSES, id);
                        }
                        expenses = expenses.filter(exp => !idsToDelete.includes(exp.id));
                        renderExpenses();
                    } catch(error) {
                        console.error("Error al eliminar los gastos visibles:", error);
                    } finally {
                        closeAllModals();
                    }
                }
            );
        }
        
        // --- INICIALIZACIÓN Y EVENT LISTENERS ---
        
        document.addEventListener('DOMContentLoaded', loadData);

        menuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        });

        sidebarOverlay.addEventListener('click', closeSidebar);

        sidebarLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const targetViewId = link.getAttribute('href').substring(1);
                views.forEach(view => view.classList.add('hidden'));
                document.getElementById(targetViewId).classList.remove('hidden');
                sidebarLinks.forEach(l => l.classList.remove('bg-gray-700'));
                link.classList.add('bg-gray-700');
                if (window.innerWidth < 768) closeSidebar();
            });
        });

        addPersonForm.addEventListener('submit', handleAddPerson);
        addExpenseForm.addEventListener('submit', handleAddExpense);
        
        peopleListDiv.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            if (target.matches('.delete-person-btn')) handleDeletePerson(parseInt(target.dataset.id));
            if (target.matches('.manage-recurring-btn')) showRecurringModal(parseInt(target.dataset.personId), target.dataset.personName);
        });
        
        recurringListDiv.addEventListener('click', (e) => {
            const target = e.target.closest('button');
             if (target && target.matches('.delete-recurring-btn')) handleDeleteRecurringExpense(parseInt(target.dataset.id));
        });

        expensesListDiv.addEventListener('click', (e) => {
            const target = e.target.closest('button.delete-expense-btn');
              if (target) handleDeleteExpense(parseInt(target.dataset.id));
        });
        
        [filterPersonSelect, filterMonthCheckbox, filterStartDateInput].forEach(el => el.addEventListener('change', renderExpenses));
        
        deleteVisibleButton.addEventListener('click', handleDeleteVisibleExpenses);
        printButton.addEventListener('click', handleGenerateShareableText);

        cancelButton.addEventListener('click', closeAllModals);
        confirmButton.addEventListener('click', () => {
            if (typeof confirmAction === 'function') confirmAction();
        });
        closeRecurringModalButton.addEventListener('click', closeAllModals);
        closeShareModalButton.addEventListener('click', closeAllModals);
        copyButton.addEventListener('click', handleCopyToClipboard);

        // Event listeners for new recurring options
        isRecurringCheckbox.addEventListener('change', () => {
            recurringOptionsDiv.classList.toggle('hidden', !isRecurringCheckbox.checked);
            if(isRecurringCheckbox.checked) {
                todayDateSpan.textContent = new Date().getDate();
            }
        });

        document.querySelectorAll('input[name="recurringType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                specificDayWrapper.classList.toggle('hidden', e.target.value !== 'specific');
            });
        });

    </script>
</body>
</html>